<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Форма с сохранением в localStorage</title>
</head>
<body>
<div class="container">
    <h1 class="mt-4">Форма с сохранением в localStorage и на сервер</h1>
    <form id="myForm" class="mt-4">
        <div class="form-group">
            <label for="name">Имя:</label>
            <input type="text" id="name" name="name" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="group">Группа:</label>
            <select id="group" name="group" class="form-control">
                <option value="ПИ21-1">ПИ21-1</option>
                <option value="ПИ21-2">ПИ21-2</option>
                <option value="ПИ21-3">ПИ21-3</option>
                <option value="ПИ21-4">ПИ21-4</option>
                <option value="ПИ21-5">ПИ21-5</option>
                <option value="ПИ21-6">ПИ21-6</option>
                <option value="ПИ21-7">ПИ21-7</option>
            </select>
        </div>
        <div class="btn-group">
            <input type="submit" class="btn btn-primary" value="Сохранить">
            <button type="button" id="cancelButton" class="btn btn-secondary">Отменить изменение</button>
        </div>
    </form>
    <label>
        <input type="checkbox" id="toggleName"> Имя
    </label>
    <label>
        <input type="checkbox" id="toggleEmail"> Email
    </label>
    <label>
        <input type="checkbox" id="toggleGroup"> Группа
    </label>
    <label>
        Поиск по всем полям:
        <input type="text" id="globalSearch" onkeyup="searchTableGlobal('globalSearch', 'dataTable')">
    </label>


    <table id="dataTable" class="table table-dark mt-4">
        <thead>
        <tr>
            <th>Имя <input type="text" id="nameSearch" onkeyup="searchTable('nameSearch', 'dataTable', 0)"
                           placeholder="Поиск по имени"></th>
            <th>Email <input type="text" id="emailSearch" onkeyup="searchTable('emailSearch', 'dataTable', 1)"
                             placeholder="Поиск по email"></th>
            <th>Группа <input type="text" id="groupSearch" onkeyup="searchTable('groupSearch', 'dataTable', 2)"
                              placeholder="Поиск по группе"></th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <!-- Здесь будут отображаться данные -->
        </tbody>
    </table>
</div>
<style>
    .hidden {
        display: none;
    }
</style>

<script>
    //Смотрим содержимое LocalStorage
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i); // Получаем ключ
        const value = localStorage.getItem(key); // Получаем значение
        console.log(`Ключ: ${key}, Значение: ${value}`);
    }

    function searchTable(inputId, tableId, columnIndex) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const table = document.getElementById(tableId);
        const tbody = table.querySelector("tbody");
        const rows = tbody.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].getElementsByTagName("td")[columnIndex];
            if (cell) {
                const textValue = cell.textContent || cell.innerText;
                if (textValue.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }

    function searchTableGlobal(inputId, tableId) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            let rowVisible = false;

            cells.forEach((cell) => {
                const textValue = cell.textContent || cell.innerText;
                if (textValue.toUpperCase().indexOf(filter) > -1) {
                    rowVisible = true;
                }
            });

            if (rowVisible) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }


    function send_to_server() {
        const data = JSON.parse(localStorage.getItem("userDataArray"));
        const url = "http://localhost:80/in_xampp/save_data.php";

        fetch(url, {
            method: "POST",
            body: JSON.stringify(data),
            headers: {
                "Content-Type": "application/json"
            },
            mode: 'no-cors' // Включаем режим no-cors
        })
            .then(response => {
                // Обработка ответа в режиме no-cors ограничена
                console.log("Запрос выполнен без CORS-проверки");
            })
            .catch(error => {
                console.error("Произошла ошибка при отправке данных:", error);
            });
    }

    const form = document.getElementById("myForm");
    const dataTable = document.getElementById("dataTable");
    const cancelButton = document.getElementById("cancelButton");
    let userDataArray = [];

    cancelButton.addEventListener("click", function () {
        form.reset();

        // Сбрасываем индекс редактирования и возвращаем текст кнопки "Сохранить"
        form.removeAttribute("data-edit-index");
        form.querySelector("input[type='submit']").value = "Сохранить";
    });

    form.addEventListener("submit", function (event) {
        event.preventDefault();

        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const group = document.getElementById("group").value;

        const editIndex = form.getAttribute("data-edit-index");

        if (editIndex !== null) {
            // If there's an edit index, update the record in the array
            userDataArray[editIndex] = {name, email, group};

            // Update the corresponding row in the table
            const row = dataTable.querySelector("tbody").rows[editIndex];
            row.cells[0].innerHTML = name;
            row.cells[1].innerHTML = email;
            row.cells[2].innerHTML = group;

            // Clear the edit index and set the submit button text back to "Сохранить"
            form.removeAttribute("data-edit-index");
            form.querySelector("input[type='submit']").value = "Сохранить";
        } else {
            // If there's no edit index, add a new record
            const newRow = dataTable.querySelector("tbody").insertRow();
            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            const cell4 = newRow.insertCell(3);
            cell1.innerHTML = name;
            cell2.innerHTML = email;
            cell3.innerHTML = group;

            const editButton = document.createElement("button");
            editButton.innerText = "Редактировать";
            editButton.addEventListener("click", () => editRow(userDataArray.length - 1));
            const deleteButton = document.createElement("button");
            deleteButton.innerText = "Удалить";
            deleteButton.addEventListener("click", () => deleteRow(userDataArray.length - 1));

            cell4.appendChild(editButton);
            cell4.appendChild(deleteButton);

            userDataArray.push({name, email, group});
        }

        // Clear the form
        form.reset();

        // Save the data to localStorage
        const userDataArrayJSON = JSON.stringify(userDataArray);
        localStorage.setItem("userDataArray", userDataArrayJSON);

        // Send data to the server
        send_to_server();
    });

    // Восстанавливаем данные из localStorage при загрузке страницы
    window.addEventListener("load", function () {
        const userDataArrayJSON = localStorage.getItem("userDataArray");

        if (userDataArrayJSON) {
            userDataArray = JSON.parse(userDataArrayJSON);

            // Восстанавливаем все записи из массива
            userDataArray.forEach((userData, index) => {
                const newRow = dataTable.querySelector("tbody").insertRow();
                const cell1 = newRow.insertCell(0);
                const cell2 = newRow.insertCell(1);
                const cell3 = newRow.insertCell(2);
                const cell4 = newRow.insertCell(3);
                cell1.innerHTML = userData.name;
                cell2.innerHTML = userData.email;
                cell3.innerHTML = userData.group;

                // Добавляем кнопки редактирования и удаления для каждой записи
                const editButton = document.createElement("button");
                editButton.innerText = "Редактировать";
                editButton.addEventListener("click", () => editRow(index));
                const deleteButton = document.createElement("button");
                deleteButton.innerText = "Удалить";
                deleteButton.addEventListener("click", () => deleteRow(index));

                // Добавляем кнопки в ячейку "Действия"
                cell4.appendChild(editButton);
                cell4.appendChild(deleteButton);
            });
        }
    });

    function editRow(index) {
        const userData = userDataArray[index];
        document.getElementById("name").value = userData.name;
        document.getElementById("email").value = userData.email;
        document.getElementById("group").value = userData.group;

        form.setAttribute("data-edit-index", index);
        form.querySelector("input[type='submit']").value = "Обновить";

        // Send data to the server
        send_to_server();
    }

    function deleteRow(index) {
        userDataArray.splice(index, 1);

        const tbody = dataTable.querySelector("tbody");
        tbody.removeChild(tbody.children[index]);

        localStorage.setItem("userDataArray", JSON.stringify(userDataArray));

        // Send data to the server
        send_to_server();
    }

    document.getElementById("toggleName").addEventListener("change", function () {
        toggleColumn(0);
    });

    document.getElementById("toggleEmail").addEventListener("change", function () {
        toggleColumn(1);
    });

    document.getElementById("toggleGroup").addEventListener("change", function () {
        toggleColumn(2);
    });

    function toggleColumn(columnIndex) {
        const table = document.getElementById("dataTable");
        const headerRow = table.querySelector("thead tr");
        const rows = table.querySelectorAll("tbody tr");
        const isColumnVisible = !headerRow.querySelectorAll("th")[columnIndex].classList.contains("hidden");

        // Скрываем или отображаем заголовок колонки
        headerRow.querySelectorAll("th")[columnIndex].classList.toggle("hidden", isColumnVisible);

        // Скрываем или отображаем данные в колонке
        rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            cells[columnIndex].classList.toggle("hidden", isColumnVisible);
        });
    }


</script>
</body>
</html>
